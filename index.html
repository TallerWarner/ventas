<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Almac√©n de Ventas - Taller</title>
  <style>
    body { background:#121212; color:#fff; font-family:Arial,sans-serif; margin:0; padding:1rem; }
    h2 { color:#ffcc00; }
    .card { background:#1e1e1e; padding:1rem; margin:1rem 0; border-radius:8px; }
    input, select, button, datalist { margin:.3rem; padding:.5rem; border-radius:5px; border:none; }
    button { background:#ffcc00; cursor:pointer; font-weight:bold; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th, td { border:1px solid #444; padding:.5rem; text-align:center; }
    th { background:#333; }
    #vistaPrevia { margin-top:.5rem; font-weight:bold; color:#4caf50; }

    /* Estilos modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #222;
      padding: 2rem;
      border-radius: 10px;
      max-width: 600px; 
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      text-align: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      animation: fadeIn 0.3s ease;
    }
    .modal-content h3 { color:#ffcc00; margin-bottom:1rem; }
    .modal-content p { margin: .5rem 0; }
    .close-btn {
      margin-top: 1rem;
      padding: .5rem 1rem;
      background: #ffcc00;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    ul { text-align:left; margin:0; padding-left:20px; }
  </style>
</head>
<body>
  <h1>Almac√©n de Ventas - Taller</h1>

  <!-- Registro de mec√°nicos -->
  <div class="card">
    <h2>üë®‚Äçüîß Registrar Mec√°nico</h2>
    <input id="nombreMecanico" placeholder="Nombre del mec√°nico">
    <select id="porcentajeMecanico">
      <option value="0">Sin porcentaje</option>
      <option value="0.20">20%</option>
      <option value="0.30">30%</option>
      <option value="0.45">45%</option>
      <option value="0.60">60%</option>
      <option value="0.70">70%</option>
    </select>
    <button onclick="registrarMecanico()">Registrar Mec√°nico</button>
  </div>

  <!-- Registrar / Editar Producto -->
  <div class="card">
    <h2>üì¶ Registrar / Editar Producto</h2>
    <input list="productosListaEditar" id="productoEditarInput" placeholder="Buscar producto" oninput="seleccionarProductoEditar()">
    <datalist id="productosListaEditar"></datalist><br>
    <input id="codigoProducto" placeholder="C√≥digo del producto">
    <input id="nombreProducto" placeholder="Nombre">
    <input id="precioProducto" type="number" placeholder="Precio unitario">
    <input id="cantidadProducto" type="number" placeholder="Cantidad">
    <input id="costoRegistro" type="number" placeholder="Costo total (opcional)">
    <button onclick="registrarProducto()">Agregar Producto</button>
    <button onclick="editarProducto()">Editar Producto</button>
    <button id="btnEliminar" onclick="eliminarProducto()" style="display:none; background:red; color:white;">Eliminar Producto ‚ùå</button>
  </div>

  <!-- Registrar venta -->
  <div class="card">
    <h2>üí∞ Registrar Venta</h2>
    <input list="productosListaVenta" id="productoVentaInput" placeholder="Buscar producto" oninput="seleccionarProductoVenta()">
    <datalist id="productosListaVenta"></datalist>
    <input id="cantidadVenta" type="number" placeholder="Cantidad"><br>
    <label>Mec√°nico:</label>
    <select id="mecanicoVenta" onchange="actualizarVistaPrevia()"></select><br>
    <label>Porcentaje extra:</label>
    <select id="extraPorcentaje" onchange="actualizarVistaPrevia()">
      <option value="0">Sin extra</option>
      <option value="0.20">20%</option>
      <option value="0.30">30%</option>
      <option value="0.45">45%</option>
      <option value="0.60">60%</option>
      <option value="0.70">70%</option>
    </select><br>
    <div id="vistaPrevia">üí≤ Precio unitario final: -</div>

    <button onclick="agregarProductoLista()">‚ûï Agregar a la lista</button>
    <table>
      <thead>
        <tr><th>C√≥digo</th><th>Producto</th><th>Cantidad</th><th>Precio Unitario</th><th>Total</th><th>Acci√≥n</th></tr>
      </thead>
      <tbody id="listaCompra"></tbody>
    </table>
    <h3>Total acumulado: üí≤<span id="totalLista">0.00</span></h3>
    <button onclick="registrarVenta()">Registrar Venta</button>
  </div>

  <!-- Registrar compra -->
  <div class="card">
    <h2>üõí Registrar Compra</h2>
    <input list="productosListaCompra" id="productoCompraInput" placeholder="Buscar producto" oninput="seleccionarProductoCompra()">
    <datalist id="productosListaCompra"></datalist>
    <input id="cantidadCompra" type="number" placeholder="Cantidad">
    <input id="costoCompra" type="number" placeholder="Costo total">
    <button onclick="registrarCompra()">Registrar Compra</button>
  </div>

  <!-- Historial -->
  <div class="card">
    <h2>üìú Historial</h2>
    <label>Filtro:</label>
    <select id="filtroTipo" onchange="mostrarHistorial()">
      <option value="todos">Todos</option>
      <option value="venta">Ventas</option>
      <option value="compra">Compras</option>
      <option value="registro">Registros</option>
      <option value="edicion">Ediciones</option>
      <option value="mecanico">Mec√°nicos</option>
    </select>
    <input type="date" id="filtroFecha" onchange="mostrarHistorial()">
    <table>
      <thead>
        <tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Monto</th></tr>
      </thead>
      <tbody id="tablaHistorial"></tbody>
    </table>
    <h3>üíµ Ganancia Total del D√≠a: <span id="ganancia">0</span></h3>
    <button onclick="exportarHistorial()">üíæ Exportar Historial JSON</button>
    <input type="file" id="importFile" style="display:none" onchange="importarHistorial(event)">
    <button onclick="document.getElementById('importFile').click()">üìÇ Importar Historial JSON</button>
    <button onclick="limpiarHistorial()" style="background:red;">üóëÔ∏è Eliminar Historial</button>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div id="ventaModal" class="modal">
    <div class="modal-content">
      <h3>‚úÖ Venta Registrada</h3>
      <p id="modalDetalle"></p>
      <p id="modalCliente"></p>
      <p id="modalTotal"></p>
      <button class="close-btn" onclick="cerrarModal()">Cerrar</button>
    </div>
  </div>

<script>
let productos = JSON.parse(localStorage.getItem("productos")) || [];
let historial = JSON.parse(localStorage.getItem("historial")) || [];
let mecanicos = JSON.parse(localStorage.getItem("mecanicos")) || [];
let listaTemporal = [];
let productoSeleccionadoIndex = null;
let productoCompraSeleccionadoIndex = null;
let productoEditarSeleccionadoIndex = null;

function fechaCDMX() {
  let fecha = new Date();
  let offset = -6;
  fecha.setHours(fecha.getUTCHours() + offset);
  return fecha.toISOString().slice(0,10);
}

function guardar() {
  localStorage.setItem("productos", JSON.stringify(productos));
  localStorage.setItem("historial", JSON.stringify(historial));
  localStorage.setItem("mecanicos", JSON.stringify(mecanicos));
  actualizarSelects();
  mostrarHistorial();
}

// ===== Registro y edici√≥n de productos =====
function registrarProducto() {
  let codigo = document.getElementById("codigoProducto").value.trim();
  let nombre = document.getElementById("nombreProducto").value;
  let precio = parseFloat(document.getElementById("precioProducto").value);
  let cantidad = parseInt(document.getElementById("cantidadProducto").value);
  let costoRegistro = parseFloat(document.getElementById("costoRegistro").value) || 0;
  if(!codigo || !nombre || precio<=0 || cantidad<=0) return alert("Datos inv√°lidos");

  productos.push({codigo, nombre, precio, cantidad});
  historial.push({fecha: fechaCDMX(), tipo:"registro", detalle:`Nuevo producto: ${nombre} (C√≥digo: ${codigo}, Precio ${precio}, Stock ${cantidad})`, monto:-costoRegistro});
  guardar();
  limpiarInputs();
  alert("Producto registrado");
}

function editarProducto() {
  let idx = productoEditarSeleccionadoIndex;
  if(idx===null) return alert("Seleccione un producto para editar");
  let codigo = document.getElementById("codigoProducto").value.trim();
  let nombre = document.getElementById("nombreProducto").value;
  let precio = parseFloat(document.getElementById("precioProducto").value);
  let cantidad = parseInt(document.getElementById("cantidadProducto").value);
  if(!codigo || !nombre || precio<=0 || cantidad<0) return alert("Datos inv√°lidos");

  productos[idx] = {codigo, nombre, precio, cantidad};
  historial.push({fecha: fechaCDMX(), tipo:"edicion", detalle:`Producto editado: ${nombre} (C√≥digo: ${codigo}, Precio ${precio}, Stock ${cantidad})`, monto:0});
  guardar();
  limpiarInputs();
  productoEditarSeleccionadoIndex = null;
  document.getElementById("btnEliminar").style.display="none";
  alert("Producto editado");
}

function eliminarProducto() {
  let idx = productoEditarSeleccionadoIndex;
  if(idx===null) return alert("Seleccione un producto para eliminar");
  let nombre = productos[idx].nombre;
  if(!confirm(`¬øSeguro que deseas eliminar "${nombre}"?`)) return;

  productos.splice(idx,1);
  historial.push({fecha: fechaCDMX(), tipo:"eliminacion", detalle:`Producto eliminado: ${nombre}`, monto:0});
  guardar();
  limpiarInputs();
  productoEditarSeleccionadoIndex = null;
  document.getElementById("btnEliminar").style.display="none";
  alert("Producto eliminado");
}

function cargarProducto() {
  if(productoEditarSeleccionadoIndex===null){ limpiarInputs(); document.getElementById("btnEliminar").style.display="none"; return; }
  let p = productos[productoEditarSeleccionadoIndex];
  document.getElementById("codigoProducto").value = p.codigo;
  document.getElementById("nombreProducto").value = p.nombre;
  document.getElementById("precioProducto").value = p.precio;
  document.getElementById("cantidadProducto").value = p.cantidad;
  document.getElementById("btnEliminar").style.display="inline-block";
}

function limpiarInputs() {
  document.getElementById("codigoProducto").value="";
  document.getElementById("nombreProducto").value="";
  document.getElementById("precioProducto").value="";
  document.getElementById("cantidadProducto").value="";
  document.getElementById("costoRegistro").value="";
}

function actualizarSelects() {
  let opcionesProductos = productos.map((p,i)=>`<option value="${i}">${p.codigo} - ${p.nombre} (Stock:${p.cantidad})</option>`).join("");
  document.getElementById("productoEditarInput").innerHTML = "";
  document.getElementById("productoCompraInput").innerHTML = "";
  document.getElementById("productosListaVenta").innerHTML = "";

  let listaEditar = productos.map((p,i)=>`<option value="${i}-${p.nombre}">${p.codigo} - ${p.nombre} (Stock:${p.cantidad})</option>`).join("");
  document.getElementById("productosListaEditar").innerHTML = listaEditar;

  let listaCompra = productos.map((p,i)=>`<option value="${i}-${p.nombre}">${p.codigo} - ${p.nombre} (Stock:${p.cantidad})</option>`).join("");
  document.getElementById("productosListaCompra").innerHTML = listaCompra;

  let listaVenta = productos.map((p,i)=>`<option value="${i}-${p.nombre}">${p.codigo} - ${p.nombre} (Stock:${p.cantidad})</option>`).join("");
  document.getElementById("productosListaVenta").innerHTML = listaVenta;

  let opcionesMec = `<option value="">Cliente</option>` + mecanicos.map((m,i)=>`<option value="${i}">${m.nombre} (+${m.porcentaje*100}%)</option>`).join("");
  document.getElementById("mecanicoVenta").innerHTML = opcionesMec;
}

// ===== Registro de mec√°nicos =====
function registrarMecanico() {
  let nombre = document.getElementById("nombreMecanico").value;
  let porcentaje = parseFloat(document.getElementById("porcentajeMecanico").value);
  if(!nombre) return alert("Ingrese el nombre del mec√°nico");

  mecanicos.push({nombre, porcentaje});
  historial.push({fecha: fechaCDMX(), tipo:"mecanico", detalle:`Nuevo mec√°nico: ${nombre} (Porcentaje fijo: ${porcentaje*100}%)`, monto:0});
  guardar();
  document.getElementById("nombreMecanico").value="";
  document.getElementById("porcentajeMecanico").value="0";
  alert("Mec√°nico registrado");
}

// ===== Funciones de selecci√≥n id√©nticas a venta =====
function seleccionarProductoVenta() {
  let input = document.getElementById("productoVentaInput").value;
  let index = parseInt(input.split("-")[0]);
  if(productos[index]){ productoSeleccionadoIndex = index; actualizarVistaPrevia(); }
  else{ productoSeleccionadoIndex = null; document.getElementById("vistaPrevia").innerText = "üí≤ Precio unitario final: -"; }
}

function seleccionarProductoCompra() {
  let input = document.getElementById("productoCompraInput").value;
  let index = parseInt(input.split("-")[0]);
  if(productos[index]){ productoCompraSeleccionadoIndex = index; }
  else{ productoCompraSeleccionadoIndex = null; }
}

function seleccionarProductoEditar() {
  let input = document.getElementById("productoEditarInput").value;
  let index = parseInt(input.split("-")[0]);
  if(productos[index]){ productoEditarSeleccionadoIndex = index; cargarProducto(); }
  else{ productoEditarSeleccionadoIndex = null; limpiarInputs(); }
}

// ===== Registro y vista de ventas =====
function actualizarVistaPrevia() {
  if(productoSeleccionadoIndex===null) return;
  let idxProd = productoSeleccionadoIndex;
  let idxMec = document.getElementById("mecanicoVenta").value;
  let extra = parseFloat(document.getElementById("extraPorcentaje").value);

  let producto = productos[idxProd];
  let precioBase = producto.precio * 1.16;
  let porcentajeMec = idxMec!=="" ? mecanicos[idxMec].porcentaje : 0;
  let precioFinal = precioBase * (1 + porcentajeMec) * (1 + extra);
  document.getElementById("vistaPrevia").innerText = `üí≤ Precio unitario final: ${precioFinal.toFixed(2)}`;
}

function agregarProductoLista() {
  if(productoSeleccionadoIndex===null) return alert("Seleccione un producto v√°lido");
  let cantidad = parseInt(document.getElementById("cantidadVenta").value);
  let idxMec = document.getElementById("mecanicoVenta").value;
  let extra = parseFloat(document.getElementById("extraPorcentaje").value);
  if(cantidad<=0) return alert("Cantidad inv√°lida");
  let producto = productos[productoSeleccionadoIndex];
  if(producto.cantidad<cantidad) return alert("No hay suficiente stock");

  let precioBase = producto.precio * 1.16;
  let porcentajeMec = idxMec!=="" ? mecanicos[idxMec].porcentaje : 0;
  let precioFinal = precioBase * (1 + porcentajeMec) * (1 + extra);

  listaTemporal.push({idx:productoSeleccionadoIndex, cantidad, precioFinal, nombre: producto.nombre, codigo: producto.codigo, total: precioFinal*cantidad, idxMec, extra});
  mostrarListaTemporal();
}

function mostrarListaTemporal() {
  let tbody = document.getElementById("listaCompra");
  tbody.innerHTML = "";
  let total = 0;
  listaTemporal.forEach((item,i)=>{
    tbody.innerHTML += `<tr>
      <td>${item.codigo}</td>
      <td>${item.nombre}</td>
      <td>${item.cantidad}</td>
      <td>${item.precioFinal.toFixed(2)}</td>
      <td>${item.total.toFixed(2)}</td>
      <td><button onclick="eliminarDeLista(${i})">‚ùå</button></td>
    </tr>`;
    total += item.total;
  });
  document.getElementById("totalLista").innerText = total.toFixed(2);
}

function eliminarDeLista(i){ listaTemporal.splice(i,1); mostrarListaTemporal(); }

function registrarVenta(){
  if(listaTemporal.length===0) return alert("No hay productos en la lista");
  let detalle = []; let total=0; let clienteInfo="";
  listaTemporal.forEach(item=>{
    productos[item.idx].cantidad -= item.cantidad;
    let mecNombre = item.idxMec!=="" ? mecanicos[item.idxMec].nombre : "Cliente";
    detalle.push({codigo:item.codigo, producto:item.nombre, cantidad:item.cantidad, precioUnitario:item.precioFinal.toFixed(2), total:item.total.toFixed(2), mecNombre:mecNombre, extra:(item.extra*100).toFixed(0)+"%"});
    total += item.total;
    clienteInfo = mecNombre;
  });
  historial.push({fecha:fechaCDMX(), tipo:"venta", detalle:detalle, monto:total.toFixed(2)});
  guardar();
  listaTemporal=[]; mostrarListaTemporal(); document.getElementById("productoVentaInput").value=""; productoSeleccionadoIndex=null;
  let modalDetalle = detalle.map(d=>`${d.cantidad} x ${d.producto} (C√≥digo: ${d.codigo}, Para: ${d.mecNombre}, Extra: ${d.extra})`).join(", ");
  document.getElementById("modalDetalle").innerText = `Productos: ${modalDetalle}`;
  document.getElementById("modalCliente").innerText = `Cliente / Mec√°nico: ${clienteInfo}`;
  document.getElementById("modalTotal").innerText = `Total: $${total.toFixed(2)}`;
  document.getElementById("ventaModal").style.display="flex";
}

function cerrarModal(){ document.getElementById("ventaModal").style.display="none"; }

// ===== Registro de compras =====
function registrarCompra() {
  if(productoCompraSeleccionadoIndex===null) return alert("Seleccione un producto v√°lido");
  let idx = productoCompraSeleccionadoIndex;
  let cantidad = parseInt(document.getElementById("cantidadCompra").value);
  let costo = parseFloat(document.getElementById("costoCompra").value);
  if(cantidad<=0 || costo<=0) return alert("Datos inv√°lidos");

  productos[idx].cantidad += cantidad;
  historial.push({
    fecha: fechaCDMX(),
    tipo: "compra",
    detalle: `Compra de ${cantidad} unidades de ${productos[idx].nombre} (C√≥digo: ${productos[idx].codigo})`,
    monto: -costo
  });
  guardar();
  document.getElementById("cantidadCompra").value = "";
  document.getElementById("costoCompra").value = "";
  alert("Compra registrada");
}

// ===== Exportar / importar historial =====
function exportarHistorial() {
  const dataStr = JSON.stringify(historial, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `historial_${fechaCDMX()}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function importarHistorial(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if(Array.isArray(data)) {
        historial = data;
        guardar();
        mostrarHistorial();
        alert("Historial importado correctamente");
      } else { alert("Archivo inv√°lido"); }
    } catch(err) { alert("Error al leer el archivo"); }
  }
  reader.readAsText(file);
}

// ===== Limpieza general =====
function limpiarHistorial() {
  if(!confirm("¬øDesea eliminar todo el historial? Esta acci√≥n no afecta productos ni mec√°nicos.")) return;
  historial = [];
  guardar();
  alert("Historial eliminado");
}

// ===== Mostrar historial =====
function mostrarHistorial() {
  let filtroTipo = document.getElementById("filtroTipo").value;
  let filtroFecha = document.getElementById("filtroFecha").value;
  let tbody = document.getElementById("tablaHistorial"); tbody.innerHTML="";
  let ganancia=0;
  historial.forEach(h=>{
    if((filtroTipo==="todos" || h.tipo===filtroTipo) && (!filtroFecha || h.fecha===filtroFecha)){
      let detalleHTML = Array.isArray(h.detalle) ? "<ul>" + h.detalle.map(d=>`<li>${d.cantidad || ''} x ${d.producto || ''} (C√≥digo: ${d.codigo || '-'}, Para: ${d.mecNombre || ''}, Extra: ${d.extra || ''})</li>`).join("") + "</ul>" : h.detalle;
      tbody.innerHTML += `<tr><td>${h.fecha}</td><td>${h.tipo}</td><td>${detalleHTML}</td><td>${h.monto}</td></tr>`;
      ganancia+=parseFloat(h.monto);
    }
  });
  document.getElementById("ganancia").innerText = ganancia.toFixed(2);
}

// ===== Inicializaci√≥n =====
actualizarSelects();
mostrarHistorial();
</script>
</body>
</html>
