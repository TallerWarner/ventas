<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Almac√©n de Ventas - Taller</title>
  <style>
    body { background:#121212; color:#fff; font-family:Arial,sans-serif; margin:0; padding:1rem; }
    h2 { color:#ffcc00; }
    .card { background:#1e1e1e; padding:1rem; margin:1rem 0; border-radius:8px; }
    input, select, button { margin:.3rem; padding:.5rem; border-radius:5px; border:none; }
    button { background:#ffcc00; cursor:pointer; font-weight:bold; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th, td { border:1px solid #444; padding:.5rem; text-align:center; }
    th { background:#333; }
    #vistaPrevia { margin-top:.5rem; font-weight:bold; color:#4caf50; }

    /* Estilos modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #222;
      padding: 2rem;
      border-radius: 10px;
      max-width: 600px;       /* M√°s grande */
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      text-align: center;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      animation: fadeIn 0.3s ease;
    }
    .modal-content h3 { color:#ffcc00; margin-bottom:1rem; }
    .modal-content p { margin: .5rem 0; }
    .close-btn {
      margin-top: 1rem;
      padding: .5rem 1rem;
      background: #ffcc00;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <h1> Almac√©n de Ventas - Taller</h1>

  <!-- Registro de mec√°nicos -->
  <div class="card">
    <h2>üë®‚Äçüîß Registrar Mec√°nico</h2>
    <input id="nombreMecanico" placeholder="Nombre del mec√°nico">
    <select id="porcentajeMecanico">
      <option value="0">Sin porcentaje</option>
      <option value="0.20">20%</option>
      <option value="0.30">30%</option>
      <option value="0.45">45%</option>
      <option value="0.60">60%</option>
      <option value="0.70">70%</option>
    </select>
    <button onclick="registrarMecanico()">Registrar Mec√°nico</button>
  </div>

  <!-- Registro de productos -->
  <div class="card">
    <h2>üì¶ Registrar / Editar Producto</h2>
    <select id="productoEditar" onchange="cargarProducto()">
      <option value="">-- Nuevo Producto --</option>
    </select><br>
    <input id="nombreProducto" placeholder="Nombre">
    <input id="precioProducto" type="number" placeholder="Precio unitario">
    <input id="cantidadProducto" type="number" placeholder="Cantidad">
    <input id="costoRegistro" type="number" placeholder="Costo total (opcional)">
    <button onclick="registrarProducto()">Agregar Producto</button>
    <button onclick="editarProducto()">Editar Producto</button>
  </div>

  <!-- Registrar venta -->
  <div class="card">
    <h2>üí∞ Registrar Venta</h2>
    <select id="productoVenta" onchange="actualizarVistaPrevia()"></select>
    <input id="cantidadVenta" type="number" placeholder="Cantidad"><br>
    <label>Mec√°nico:</label>
    <select id="mecanicoVenta" onchange="actualizarVistaPrevia()"></select><br>
    <label>Porcentaje extra:</label>
    <select id="extraPorcentaje" onchange="actualizarVistaPrevia()">
      <option value="0">Sin extra</option>
      <option value="0.20">20%</option>
      <option value="0.30">30%</option>
      <option value="0.45">45%</option>
      <option value="0.60">60%</option>
      <option value="0.70">70%</option>
    </select><br>
    <div id="vistaPrevia">üí≤ Precio unitario final: -</div>
    <button onclick="registrarVenta()">Registrar Venta</button>
  </div>

  <!-- Registrar compra -->
  <div class="card">
    <h2>üõí Registrar Compra</h2>
    <select id="productoCompra"></select>
    <input id="cantidadCompra" type="number" placeholder="Cantidad">
    <input id="costoCompra" type="number" placeholder="Costo total">
    <button onclick="registrarCompra()">Registrar Compra</button>
  </div>

  <!-- Historial -->
  <div class="card">
    <h2>üìú Historial</h2>
    <label>Filtro:</label>
    <select id="filtroTipo" onchange="mostrarHistorial()">
      <option value="todos">Todos</option>
      <option value="venta">Ventas</option>
      <option value="compra">Compras</option>
      <option value="registro">Registros</option>
      <option value="edicion">Ediciones</option>
      <option value="mecanico">Mec√°nicos</option>
    </select>
    <input type="date" id="filtroFecha" onchange="mostrarHistorial()">
    <table>
      <thead>
        <tr><th>Fecha</th><th>Tipo</th><th>Detalle</th><th>Monto</th></tr>
      </thead>
      <tbody id="tablaHistorial"></tbody>
    </table>
    <h3>üíµ Ganancia Total del D√≠a: <span id="ganancia">0</span></h3>
    <button onclick="exportarHistorial()">üíæ Exportar Historial JSON</button>
    <input type="file" id="importFile" style="display:none" onchange="importarHistorial(event)">
    <button onclick="document.getElementById('importFile').click()">üìÇ Importar Historial JSON</button>
    <button onclick="limpiezaGeneral()">üßπ Limpieza General (Respaldo autom√°tico)</button>
  </div>

  <!-- Modal de confirmaci√≥n -->
  <div id="ventaModal" class="modal">
    <div class="modal-content">
      <h3>‚úÖ Venta Registrada</h3>
      <p id="modalDetalle"></p>
      <p id="modalPrecioUnitario"></p>
      <p id="modalCliente"></p>
      <p id="modalTotal"></p>
      <button class="close-btn" onclick="cerrarModal()">Cerrar</button>
    </div>
  </div>

  <script>
    let productos = JSON.parse(localStorage.getItem("productos")) || [];
    let historial = JSON.parse(localStorage.getItem("historial")) || [];
    let mecanicos = JSON.parse(localStorage.getItem("mecanicos")) || [];

    function guardar() {
      localStorage.setItem("productos", JSON.stringify(productos));
      localStorage.setItem("historial", JSON.stringify(historial));
      localStorage.setItem("mecanicos", JSON.stringify(mecanicos));
    }

    function registrarMecanico() {
      let nombre = document.getElementById("nombreMecanico").value;
      let porcentaje = parseFloat(document.getElementById("porcentajeMecanico").value);
      if (!nombre) return alert("Ingrese el nombre del mec√°nico");

      mecanicos.push({nombre, porcentaje});
      historial.push({
        fecha:new Date().toISOString().slice(0,10),
        tipo:"mecanico",
        detalle:`Nuevo mec√°nico: ${nombre} (Porcentaje fijo: ${porcentaje*100}%)`,
        monto:0
      });
      guardar();
      actualizarSelects();
      document.getElementById("nombreMecanico").value = "";
      document.getElementById("porcentajeMecanico").value = "0";
      alert("Mec√°nico registrado");
    }

    function registrarProducto() {
      let nombre = document.getElementById("nombreProducto").value;
      let precio = parseFloat(document.getElementById("precioProducto").value);
      let cantidad = parseInt(document.getElementById("cantidadProducto").value);
      let costoRegistro = parseFloat(document.getElementById("costoRegistro").value) || 0;

      if (!nombre || precio<=0 || cantidad<=0) return alert("Datos inv√°lidos");

      productos.push({nombre, precio, cantidad});
      historial.push({
        fecha:new Date().toISOString().slice(0,10),
        tipo:"registro",
        detalle:`Nuevo producto: ${nombre} (Precio ${precio}, Stock ${cantidad})`,
        monto:-costoRegistro
      });
      guardar();
      actualizarSelects();
      mostrarHistorial();
      limpiarInputs();
      alert("Producto registrado");
    }

    function actualizarSelects() {
      let opciones = productos.map((p,i)=>`<option value="${i}">${p.nombre} (Stock:${p.cantidad})</option>`).join("");
      document.getElementById("productoVenta").innerHTML = opciones;
      document.getElementById("productoCompra").innerHTML = opciones;
      document.getElementById("productoEditar").innerHTML = `<option value="">-- Nuevo Producto --</option>` + opciones;

      let opcionesMec = `<option value="">Cliente</option>` + mecanicos.map((m,i)=>`<option value="${i}">${m.nombre} (+${m.porcentaje*100}%)</option>`).join("");
      document.getElementById("mecanicoVenta").innerHTML = opcionesMec;
    }

    function actualizarVistaPrevia() {
      let idxProd = document.getElementById("productoVenta").value;
      let idxMec = document.getElementById("mecanicoVenta").value;
      let extra = parseFloat(document.getElementById("extraPorcentaje").value);

      if (idxProd === "") {
        document.getElementById("vistaPrevia").innerText = "üí≤ Precio unitario final: -";
        return;
      }

      let producto = productos[idxProd];
      let precioBase = producto.precio * 1.16;
      let porcentajeMec = idxMec !== "" ? mecanicos[idxMec].porcentaje : 0;
      let precioFinal = precioBase * (1 + porcentajeMec) * (1 + extra);
      document.getElementById("vistaPrevia").innerText = `üí≤ Precio unitario final: ${precioFinal.toFixed(2)}`;
    }

    function registrarVenta() {
      let idx = document.getElementById("productoVenta").value;
      let cantidad = parseInt(document.getElementById("cantidadVenta").value);
      let idxMec = document.getElementById("mecanicoVenta").value;
      let extra = parseFloat(document.getElementById("extraPorcentaje").value);

      if (idx==="" || cantidad<=0) return alert("Datos inv√°lidos");

      let producto = productos[idx];
      if (producto.cantidad < cantidad) return alert("No hay suficiente stock");

      producto.cantidad -= cantidad;
      let precioBase = producto.precio * 1.16;
      let porcentajeMec = idxMec !== "" ? mecanicos[idxMec].porcentaje : 0;
      let nombreMec = idxMec !== "" ? mecanicos[idxMec].nombre : "Cliente";
      let precioFinal = precioBase * (1 + porcentajeMec) * (1 + extra);
      let monto = precioFinal * cantidad;

      historial.push({
        fecha:new Date().toISOString().slice(0,10),
        tipo:"venta",
        detalle:`${cantidad} x ${producto.nombre} - Vendedor: ${nombreMec}`,
        monto:monto.toFixed(2)
      });
      guardar();
      mostrarHistorial();
      actualizarSelects();
      actualizarVistaPrevia();

      document.getElementById("modalDetalle").innerText = `Producto: ${cantidad} x ${producto.nombre}`;
      document.getElementById("modalPrecioUnitario").innerText = `Precio unitario final: $${precioFinal.toFixed(2)}`;
      document.getElementById("modalCliente").innerText = `Vendido a: ${nombreMec}`;
      document.getElementById("modalTotal").innerText = `Total de la venta: $${monto.toFixed(2)}`;
      document.getElementById("ventaModal").style.display = "flex";
    }

    function cerrarModal() {
      document.getElementById("ventaModal").style.display = "none";
    }

    function mostrarHistorial() {
      let filtroTipo = document.getElementById("filtroTipo").value;
      let filtroFecha = document.getElementById("filtroFecha").value;
      let tbody = document.getElementById("tablaHistorial");
      tbody.innerHTML = "";
      let ganancia = 0;
      historial.forEach(h=>{
        if ((filtroTipo==="todos" || h.tipo===filtroTipo) && (!filtroFecha || h.fecha===filtroFecha)) {
          tbody.innerHTML += `<tr><td>${h.fecha}</td><td>${h.tipo}</td><td>${h.detalle}</td><td>${h.monto}</td></tr>`;
          ganancia += parseFloat(h.monto);
        }
      });
      document.getElementById("ganancia").innerText = ganancia.toFixed(2);
    }

    function registrarCompra() {
      let idx = document.getElementById("productoCompra").value;
      let cantidad = parseInt(document.getElementById("cantidadCompra").value);
      let costo = parseFloat(document.getElementById("costoCompra").value);
      if (idx==="" || cantidad<=0 || costo<=0) return alert("Datos inv√°lidos");
      productos[idx].cantidad += cantidad;
      historial.push({fecha:new Date().toISOString().slice(0,10), tipo:"compra", detalle:`${cantidad} x ${productos[idx].nombre}`, monto:-costo});
      guardar();
      mostrarHistorial();
      actualizarSelects();
      alert("Compra registrada");
    }

    function exportarHistorial() {
      const dataStr = JSON.stringify({productos,historial,mecanicos}, null, 2);
      const blob = new Blob([dataStr], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `historial_taller_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importarHistorial(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          if (data.productos && data.historial && data.mecanicos) {
            productos = data.productos;
            historial = data.historial;
            mecanicos = data.mecanicos;
            guardar();
            actualizarSelects();
            mostrarHistorial();
            actualizarVistaPrevia();
            alert("Importaci√≥n exitosa");
          } else alert("Archivo inv√°lido");
        } catch(err) { alert("Error al leer el archivo"); }
      };
      reader.readAsText(file);
    }

    function limpiezaGeneral() {
      exportarHistorial();
      productos = [];
      historial = [];
      mecanicos = [];
      guardar();
      actualizarSelects();
      mostrarHistorial();
      alert("Sistema limpio, respaldo generado");
    }

    // Inicializar
    actualizarSelects();
    mostrarHistorial();
  </script>
</body>
</html>
